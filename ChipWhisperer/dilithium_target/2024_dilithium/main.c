#include <stddef.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include "randombytes.h"
#include "sign.h"
#include "polyvec.h"
#include "packing.h"

#define MLEN 32
#define NTESTS 1

//这是官方的消息用来验证
uint8_t m[MLEN];
size_t smlen;
//uint8_t m[MLEN] = {0}; //这里不要修改
uint8_t sm[MLEN + CRYPTO_BYTES]; //签名后的 2420 + MLEN = 2453
uint8_t m2[MLEN + CRYPTO_BYTES];
uint8_t pk[CRYPTO_PUBLICKEYBYTES];//1312 = 5* 255+37
uint8_t sk[CRYPTO_SECRETKEYBYTES];//2528
uint8_t c[SEEDBYTES];
uint8_t rho[SEEDBYTES];
uint8_t rhop[SEEDBYTES];
uint8_t tr[SEEDBYTES];
uint8_t key[SEEDBYTES];
polyveck t1,h,t0,s2;
polyvecl z,s1,temp;
poly cp;
  //这是官方的seed用来验证
  //uint8_t SEED[SEEDBYTES]={0x7c,0x99,0x35,0xa0,0xb0,0x76,0x94,0xaa,0x0c,0x6d,0x10,0xe4,0xdb,0x6b,0x1a,0xdd,0x2f,0xd8,0x1a,0x25,0xcc,0xb1,0x48,0x03,0x2d,0xcd,0x73,0x99,0x36,0x73,0x7f,0x2d};  //32

  //这是batch0的seed
  //uint8_t SEED[SEEDBYTES] = {0x06,0x10,0x67,0x8f,0xf4,0xdc,0x31,0x28,0xe1,0x61,0x9f,0x91,0x5d,0xc1,0x92,0xc2,0x20,0xf8,0xfa,0xd9,0x4d,0xa1,0x94,0x3b,0x90,0xaa,0xec,0x40,0x16,0x83,0xa4,0x92};
  //uint8_t SEED[SEEDBYTES] = {0xef,0x99,0x22,0x4a,0x03,0xa8,0x5a,0x46,0xef,0x11,0x54,0x74,0xec,0x5b,0x5d,0x62,0x0d,0xa6,0x79,0x5d,0x6e,0xfc,0xca,0x4c,0x91,0x35,0xd1,0x99,0x58,0xa9,0xde,0x62};
  //uint8_t SEED[SEEDBYTES] = {0x9f,0x52,0xaf,0x92,0xca,0x16,0x5f,0xdc,0x38,0x78,0x8f,0x2b,0x59,0xba,0x02,0xe0,0x1c,0x82,0x81,0xff,0x7c,0x1e,0x60,0x50,0x46,0x88,0x04,0x3a,0x5f,0xe8,0x14,0xb0};
  //uint8_t SEED[SEEDBYTES] = {0x61,0x0a,0xfb,0x64,0xbe,0x8c,0xc1,0xdf,0x28,0x8c,0xfb,0x01,0x6e,0xe2,0xf4,0x4c,0x6c,0x07,0x11,0x3d,0xe7,0xf6,0xfe,0xe0,0x71,0xfe,0x0c,0x3f,0xe3,0x1c,0x62,0x15};
uint8_t SEED[SEEDBYTES] = {0x3e,0x80,0x9e,0xc8,0xdd,0x0f,0xec,0x0d,0x91,0x1a,0x4e,0x3f,0xac,0x20,0xf7,0x0f,0xbb,0x12,0x8c,0x5d,0xe9,0x4d,0xc7,0x18,0x4c,0xa7,0x31,0x0a,0xe9,0x15,0x7a,0x98};

uint8_t get_msg(uint8_t* data, uint8_t dlen)
{
  crypto_sign_keypair(pk,sk,SEED);
  crypto_sign(sm,&smlen, data, MLEN,sk);
  unpack_sig(c,&z,&h,sm);
  simpleserial_put('r', 32, c);
  return 0;
}


//////////////////////////////


int main(void)
{	
	platform_init();
	init_uart();
	trigger_setup();	
	simpleserial_init();
  
  

  simpleserial_addcmd('p',32,get_msg);

	while(1)
		simpleserial_get();
}